% ==============================================================================
% DOCUMENTACIÓN CIENTÍFICA - WARPING PIECEWISE AFFINE
% Proyecto: Detección de COVID-19 mediante Landmarks Anatómicos
% Sesiones cubiertas: 18, 20
% Nivel: Doctoral/Científico - Completo y Detallado
% ==============================================================================

\documentclass[12pt,a4paper]{article}
\input{00_preambulo}

\title{Normalización Geométrica mediante\\Warping Piecewise Affine:\\
Fundamentos y Aplicación a Radiografías Torácicas}
\author{Documentación del Proceso de Desarrollo}
\date{Sesiones: 18, 20}

\begin{document}
\maketitle

\begin{abstract}
Este documento presenta la implementación de un sistema de normalización
geométrica para radiografías de tórax basado en warping piecewise affine.
La técnica utiliza la triangulación de Delaunay sobre los 15 landmarks
anatómicos para definir regiones de transformación afín independiente,
permitiendo deformar imágenes de pacientes con anatomía variable hacia
una forma canónica común. Se desarrolla la teoría matemática de las
coordenadas baricéntricas y transformaciones afines triangulares,
incluyendo las condiciones de continuidad en los bordes. La implementación
inicial con 18 triángulos sobre los landmarks produjo un fill rate de
solo 47.1\%, problema resuelto mediante extensión del dominio con 8 puntos
de borde adicionales, alcanzando un fill rate del 96.1\%. El sistema
procesa el test set completo (96 imágenes) utilizando landmarks predichos
por el modelo ensemble, demostrando que la normalización geométrica es
viable en un pipeline de inferencia end-to-end sin requerir anotación
manual de landmarks en tiempo de ejecución.
\end{abstract}

\tableofcontents
\newpage

% ==============================================================================
\section{Introducción y Motivación}
% ==============================================================================

\subsection{El Problema de la Variabilidad Geométrica}

Las radiografías de tórax de diferentes pacientes presentan variabilidad
geométrica significativa debido a:

\begin{enumerate}
    \item \textbf{Variabilidad anatómica inter-paciente}: Diferencias en
    tamaño del tórax, proporciones, ángulos costales, posición del corazón
    \item \textbf{Variabilidad de posicionamiento}: Distancia al detector,
    rotación del torso, inspiración/expiración
    \item \textbf{Parámetros de adquisición}: Magnificación, colimación,
    centrado del haz
\end{enumerate}

Esta variabilidad geométrica puede confundir a un clasificador de CNN,
que podría aprender a discriminar basándose en características geométricas
irrelevantes en lugar de patrones patológicos genuinos.

\subsection{Enfoque de Normalización Geométrica}

La normalización geométrica busca transformar todas las imágenes a un
espacio anatómico común donde:

\begin{itemize}
    \item La variabilidad de forma inter-paciente sea eliminada
    \item Los patrones patológicos (consolidaciones, opacidades) se preserven
    \item Las características texturales sean comparables entre pacientes
\end{itemize}

El warping piecewise affine es especialmente adecuado para este problema
porque:

\begin{enumerate}
    \item Preserva líneas rectas localmente (transformaciones afines)
    \item Permite deformaciones no rígidas globalmente (composición de transformaciones)
    \item Es computacionalmente eficiente ($O(n)$ en número de píxeles)
    \item Proporciona control explícito sobre puntos de correspondencia
\end{enumerate}

\subsection{Pipeline de Normalización}

El pipeline completo de normalización geométrica consta de:

\begin{enumerate}
    \item \textbf{Predicción de landmarks}: El modelo de regresión predice
    15 landmarks anatómicos en la imagen de entrada
    \item \textbf{Triangulación}: Se define una partición triangular del
    dominio usando triangulación de Delaunay
    \item \textbf{Warping}: Cada triángulo se transforma independientemente
    mediante una transformación afín que mapea landmarks predichos a
    landmarks canónicos
    \item \textbf{Composición}: Los triángulos warpeados se combinan para
    formar la imagen normalizada
\end{enumerate}

% ==============================================================================
\section{Fundamentos Teóricos}
% ==============================================================================

\subsection{Transformaciones Afines en 2D}

\begin{definicion}[Transformación Afín]
Una transformación afín $\mathcal{A}: \R^2 \to \R^2$ es una función de la forma:
\begin{equation}
\mathcal{A}(\vect{x}) = A\vect{x} + \vect{t}
\end{equation}
donde $A \in \R^{2 \times 2}$ es una matriz invertible y $\vect{t} \in \R^2$
es un vector de traslación.
\end{definicion}

En forma matricial homogénea:
\begin{equation}
\begin{pmatrix} x' \\ y' \\ 1 \end{pmatrix} =
\begin{pmatrix}
a_{11} & a_{12} & t_x \\
a_{21} & a_{22} & t_y \\
0 & 0 & 1
\end{pmatrix}
\begin{pmatrix} x \\ y \\ 1 \end{pmatrix}
\label{eq:affine_homogeneous}
\end{equation}

\begin{proposicion}[Propiedades de Transformaciones Afines]
Las transformaciones afines preservan:
\begin{enumerate}
    \item \textbf{Colinealidad}: Puntos colineales permanecen colineales
    \item \textbf{Razones de distancias}: Si $C$ divide $AB$ en razón $r$,
    la imagen $C'$ divide $A'B'$ en la misma razón
    \item \textbf{Paralelismo}: Rectas paralelas permanecen paralelas
\end{enumerate}
Sin embargo, NO preservan:
\begin{itemize}
    \item Distancias (excepto isometrías)
    \item Ángulos (excepto transformaciones conformes)
    \item Razones de áreas (excepto si $|\det(A)| = 1$)
\end{itemize}
\end{proposicion}

\subsection{Coordenadas Baricéntricas}

\begin{definicion}[Coordenadas Baricéntricas]
Dado un triángulo con vértices $\vect{v}_1, \vect{v}_2, \vect{v}_3 \in \R^2$,
las coordenadas baricéntricas de un punto $\vect{p}$ son los escalares
$(\lambda_1, \lambda_2, \lambda_3)$ tales que:
\begin{equation}
\vect{p} = \lambda_1 \vect{v}_1 + \lambda_2 \vect{v}_2 + \lambda_3 \vect{v}_3
\label{eq:barycentric_def}
\end{equation}
con la restricción:
\begin{equation}
\lambda_1 + \lambda_2 + \lambda_3 = 1
\label{eq:barycentric_constraint}
\end{equation}
\end{definicion}

\begin{proposicion}[Cálculo de Coordenadas Baricéntricas]
Las coordenadas baricéntricas pueden calcularse mediante:
\begin{equation}
\lambda_i = \frac{\text{Área}(T_i)}{\text{Área}(T)}
\end{equation}
donde $T$ es el triángulo original y $T_i$ es el triángulo formado por
$\vect{p}$ y los dos vértices opuestos a $\vect{v}_i$.

Explícitamente:
\begin{align}
\lambda_1 &= \frac{(y_2 - y_3)(x - x_3) + (x_3 - x_2)(y - y_3)}{(y_2 - y_3)(x_1 - x_3) + (x_3 - x_2)(y_1 - y_3)} \\
\lambda_2 &= \frac{(y_3 - y_1)(x - x_3) + (x_1 - x_3)(y - y_3)}{(y_2 - y_3)(x_1 - x_3) + (x_3 - x_2)(y_1 - y_3)} \\
\lambda_3 &= 1 - \lambda_1 - \lambda_2
\end{align}
\end{proposicion}

\begin{teorema}[Criterio de Pertenencia]
Un punto $\vect{p}$ está en el interior del triángulo si y solo si:
\begin{equation}
\lambda_1 > 0, \quad \lambda_2 > 0, \quad \lambda_3 > 0
\end{equation}
El punto está en un borde si exactamente una coordenada es 0, y en un
vértice si exactamente dos coordenadas son 0.
\end{teorema}

\subsection{Transformación Afín Determinada por Tres Puntos}

\begin{teorema}[Existencia y Unicidad]
\label{thm:affine_uniqueness}
Dados dos triángulos no degenerados con vértices
$\{P_1, P_2, P_3\}$ (fuente) y $\{Q_1, Q_2, Q_3\}$ (destino),
existe una única transformación afín $\mathcal{A}$ tal que
$\mathcal{A}(P_i) = Q_i$ para $i = 1, 2, 3$.
\end{teorema}

\begin{proof}
La transformación afín tiene 6 parámetros ($a_{11}, a_{12}, a_{21}, a_{22},
t_x, t_y$). Cada par de puntos correspondientes proporciona 2 ecuaciones:
\begin{align}
x'_i &= a_{11}x_i + a_{12}y_i + t_x \\
y'_i &= a_{21}x_i + a_{22}y_i + t_y
\end{align}

Con 3 pares, tenemos 6 ecuaciones lineales para 6 incógnitas. El sistema
es:
\begin{equation}
\begin{pmatrix}
x_1 & y_1 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & x_1 & y_1 & 1 \\
x_2 & y_2 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & x_2 & y_2 & 1 \\
x_3 & y_3 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & x_3 & y_3 & 1
\end{pmatrix}
\begin{pmatrix}
a_{11} \\ a_{12} \\ t_x \\ a_{21} \\ a_{22} \\ t_y
\end{pmatrix}
=
\begin{pmatrix}
x'_1 \\ y'_1 \\ x'_2 \\ y'_2 \\ x'_3 \\ y'_3
\end{pmatrix}
\end{equation}

La matriz tiene determinante no nulo si y solo si los puntos fuente no
son colineales (triángulo no degenerado). Por tanto, existe solución única.
\end{proof}

\begin{corolario}[Cálculo Eficiente]
La matriz de transformación puede calcularse como:
\begin{equation}
M = T_{\text{dst}} \cdot T_{\text{src}}^{-1}
\end{equation}
donde:
\begin{equation}
T_{\text{src}} = \begin{pmatrix}
x_1 & x_2 & x_3 \\
y_1 & y_2 & y_3 \\
1 & 1 & 1
\end{pmatrix}, \quad
T_{\text{dst}} = \begin{pmatrix}
x'_1 & x'_2 & x'_3 \\
y'_1 & y'_2 & y'_3 \\
1 & 1 & 1
\end{pmatrix}
\end{equation}
En OpenCV, esto se implementa mediante \texttt{cv2.getAffineTransform()}.
\end{corolario}

\subsection{Warping Piecewise Affine}

\begin{definicion}[Warping Piecewise Affine]
Dada una partición triangular $\mathcal{T} = \{T_1, \ldots, T_k\}$ de un
dominio $\Omega \subset \R^2$ y correspondencias de vértices entre
triángulos fuente y destino, el warping piecewise affine es la función
$W: \Omega \to \R^2$ definida por:
\begin{equation}
W(\vect{x}) = \mathcal{A}_i(\vect{x}) \quad \text{si } \vect{x} \in T_i
\end{equation}
donde $\mathcal{A}_i$ es la transformación afín única determinada por los
vértices de $T_i$ y sus correspondientes en el destino.
\end{definicion}

\begin{teorema}[Continuidad en Bordes]
\label{thm:boundary_continuity}
El warping piecewise affine es continuo en todo el dominio $\Omega$,
incluyendo los bordes entre triángulos adyacentes.
\end{teorema}

\begin{proof}
Sean $T_i$ y $T_j$ dos triángulos adyacentes que comparten un borde $e$
con vértices $\vect{v}_a$ y $\vect{v}_b$.

Para cualquier punto $\vect{p}$ en el borde $e$:
\begin{equation}
\vect{p} = (1-t)\vect{v}_a + t\vect{v}_b, \quad t \in [0, 1]
\end{equation}

Por la propiedad de las transformaciones afines de preservar razones:
\begin{align}
\mathcal{A}_i(\vect{p}) &= (1-t)\mathcal{A}_i(\vect{v}_a) + t\mathcal{A}_i(\vect{v}_b) \\
&= (1-t)\vect{v}'_a + t\vect{v}'_b \\
&= \mathcal{A}_j(\vect{p})
\end{align}
donde $\vect{v}'_a, \vect{v}'_b$ son los vértices destino correspondientes.

Como $\mathcal{A}_i$ y $\mathcal{A}_j$ deben mapear los mismos vértices
compartidos a los mismos destinos, ambas funciones coinciden en todo el borde.
\end{proof}

\begin{observacion}[Continuidad $C^0$ pero no $C^1$]
El warping piecewise affine es continuo ($C^0$) pero generalmente no es
diferenciable ($C^1$) en los bordes de los triángulos. El gradiente de
la imagen puede ser discontinuo en estos bordes.
\end{observacion}

% ==============================================================================
\section{Triangulación de Delaunay}
% ==============================================================================

\subsection{Definición y Propiedades}

\begin{definicion}[Triangulación de Delaunay]
Dado un conjunto de puntos $P = \{p_1, \ldots, p_n\} \subset \R^2$, una
triangulación de Delaunay es una triangulación tal que ningún punto de $P$
está en el interior del circuncírculo de ningún triángulo.
\end{definicion}

\begin{teorema}[Existencia y Propiedades]
Para puntos en posición general (sin cuatro puntos cocirculares):
\begin{enumerate}
    \item La triangulación de Delaunay existe y es única
    \item Maximiza el ángulo mínimo entre todas las triangulaciones posibles
    \item Es dual del diagrama de Voronoi
\end{enumerate}
\end{teorema}

\begin{proposicion}[Optimalidad de Delaunay]
La triangulación de Delaunay es óptima para warping porque:
\begin{enumerate}
    \item Evita triángulos ``delgados'' que producen transformaciones
    mal condicionadas
    \item Maximiza la regularidad de la partición
    \item Es computacionalmente eficiente ($O(n \log n)$ para construcción)
\end{enumerate}
\end{proposicion}

\subsection{Aplicación a Landmarks Anatómicos}

Para nuestros 15 landmarks anatómicos, la triangulación de Delaunay produce
18 triángulos que conectan estructuras anatómicas relacionadas:

\begin{table}[htbp]
\centering
\caption{Triángulos de Delaunay sobre 15 landmarks}
\label{tab:delaunay_triangles}
\begin{tabular}{clll}
\toprule
\textbf{\#} & \textbf{Vértices} & \textbf{Región Anatómica} \\
\midrule
1 & L2-L15-L14 & Base inferior \\
2 & L13-L1-L12 & Borde superior \\
3 & L7-L5-L11 & Región media izquierda \\
4 & L7-L2-L14 & Base izquierda \\
5 & L2-L7-L11 & Centro-inferior izq. \\
6 & L5-L10-L11 & Hilio izquierdo \\
7 & L10-L6-L11 & Hilio derecho \\
8 & L6-L8-L11 & Región media derecha \\
9 & L2-L8-L15 & Base derecha \\
10 & L8-L2-L11 & Centro-inferior der. \\
11 & L3-L10-L5 & Ápice-hilio izq. \\
12 & L10-L4-L6 & Ápice-hilio der. \\
13 & L4-L9-L13 & Superior derecha \\
14 & L9-L4-L10 & Centro superior \\
15 & L9-L1-L13 & Mediastino der. \\
16 & L1-L9-L12 & Mediastino izq. \\
17 & L9-L3-L12 & Superior izquierda \\
18 & L3-L9-L10 & Centro-ápice \\
\bottomrule
\end{tabular}
\end{table}

\begin{observacion}[Consistencia Topológica]
La triangulación de Delaunay sobre la forma canónica produce exactamente
la misma topología (mismos índices de triángulos) que sobre cualquier
forma individual del dataset, siempre que los landmarks no cambien de
posición relativa drásticamente. Esta consistencia es esencial para el
warping.
\end{observacion}

% ==============================================================================
\section{Problema del Fill Rate y Extensión de Dominio}
% ==============================================================================

\subsection{Definición del Problema}

\begin{definicion}[Fill Rate]
El fill rate de una imagen warpeada es la proporción de píxeles que
reciben un valor válido del warping:
\begin{equation}
\text{Fill Rate} = \frac{\#\{\text{píxeles con valor asignado}\}}{\text{Total de píxeles}}
\label{eq:fill_rate}
\end{equation}
\end{definicion}

\begin{problema}[Cobertura Insuficiente]
La triangulación de Delaunay sobre los 15 landmarks anatómicos produce
triángulos que solo cubren la región pulmonar central. Los bordes de la
imagen (especialmente las esquinas) quedan fuera de cualquier triángulo,
produciendo píxeles negros (sin valor) en la imagen warpeada.
\end{problema}

\begin{table}[htbp]
\centering
\caption{Fill rate con triangulación original (solo 15 landmarks)}
\label{tab:fill_rate_original}
\begin{tabular}{lc}
\toprule
\textbf{Métrica} & \textbf{Valor} \\
\midrule
Fill rate medio & 47.1\% \\
Desviación estándar & 3.2\% \\
Mínimo & 38.9\% \\
Máximo & 54.7\% \\
\bottomrule
\end{tabular}
\end{table}

\begin{hallazgo}[title={Fill rate insuficiente con solo landmarks}]
Con la triangulación original sobre 15 landmarks, más de la mitad de la
imagen queda sin valor asignado. Esto es problemático porque:
\begin{enumerate}
    \item Pérdida de información anatómica periférica (ángulos costofrénicos
    completos, partes de las clavículas)
    \item Inconsistencia en la entrada al clasificador (áreas negras variables)
    \item Potencial sesgo por la cantidad de fondo negro
\end{enumerate}
\end{hallazgo}

\subsection{Solución: Extensión de Dominio con Puntos de Borde}

Para garantizar cobertura completa, se agregan puntos adicionales en los
bordes de la imagen:

\begin{definicion}[Puntos de Borde]
Se añaden 8 puntos auxiliares:
\begin{itemize}
    \item 4 esquinas: $(0, 0)$, $(223, 0)$, $(0, 223)$, $(223, 223)$
    \item 4 puntos medios de bordes: $(112, 0)$, $(0, 112)$, $(223, 112)$, $(112, 223)$
\end{itemize}
Total de puntos: $15 + 8 = 23$
\end{definicion}

\begin{observacion}[Correspondencia de Puntos de Borde]
Los puntos de borde son idénticos tanto en la imagen fuente como en la
imagen destino (forma canónica). Esto significa que:
\begin{enumerate}
    \item Los bordes de la imagen se preservan exactamente
    \item Solo la región interior (delimitada por los landmarks) se deforma
    \item Los triángulos de borde conectan landmarks con puntos fijos
\end{enumerate}
\end{observacion}

La nueva triangulación sobre 23 puntos produce aproximadamente 32-36
triángulos (dependiendo de la configuración exacta de landmarks).

\begin{table}[htbp]
\centering
\caption{Fill rate con triangulación extendida (23 puntos)}
\label{tab:fill_rate_extended}
\begin{tabular}{lc}
\toprule
\textbf{Métrica} & \textbf{Valor} \\
\midrule
Fill rate medio & 96.1\% \\
Desviación estándar & 1.4\% \\
Mínimo & 93.2\% \\
Máximo & 98.7\% \\
\bottomrule
\end{tabular}
\end{table}

\begin{resultadoimportante}[title={Extensión de dominio resuelve el problema}]
Agregar 8 puntos de borde aumenta el fill rate de 47.1\% a 96.1\%,
resolviendo el problema de cobertura. El 3.9\% restante corresponde a:
\begin{itemize}
    \item Pequeñas regiones cerca de triángulos muy agudos
    \item Efectos de borde en la interpolación
    \item Píxeles en las esquinas exactas de algunos triángulos
\end{itemize}
\end{resultadoimportante}

% ==============================================================================
\section{Algoritmo de Warping}
% ==============================================================================

\subsection{Descripción del Algoritmo}

El warping piecewise affine se implementa mediante el siguiente algoritmo:

\begin{algorithm}[H]
\caption{Warping Piecewise Affine}
\label{alg:piecewise_affine_warp}
\begin{algorithmic}[1]
\REQUIRE Imagen fuente $I_{\text{src}}$, Landmarks fuente $L_{\text{src}}$ (15, 2), Landmarks canónicos $L_{\text{dst}}$ (15, 2), Tamaño de salida $N$
\ENSURE Imagen warpeada $I_{\text{dst}}$
\STATE \COMMENT{Paso 1: Extensión de dominio}
\STATE $P_{\text{src}} \leftarrow$ ExtenderConBordes($L_{\text{src}}$, $N$) \COMMENT{(23, 2)}
\STATE $P_{\text{dst}} \leftarrow$ ExtenderConBordes($L_{\text{dst}}$, $N$) \COMMENT{(23, 2)}
\STATE \COMMENT{Paso 2: Triangulación}
\STATE $\mathcal{T} \leftarrow$ Delaunay($P_{\text{dst}}$) \COMMENT{Sobre puntos destino}
\STATE \COMMENT{Paso 3: Inicializar imagen destino}
\STATE $I_{\text{dst}} \leftarrow$ zeros($N$, $N$)
\STATE \COMMENT{Paso 4: Warpear cada triángulo}
\FORALL{triángulo $T_k$ en $\mathcal{T}$}
    \STATE $\vect{v}_{\text{src}} \leftarrow P_{\text{src}}[T_k.\text{indices}]$ \COMMENT{Vértices fuente}
    \STATE $\vect{v}_{\text{dst}} \leftarrow P_{\text{dst}}[T_k.\text{indices}]$ \COMMENT{Vértices destino}
    \STATE \COMMENT{4a: Calcular bounding boxes}
    \STATE $\text{BB}_{\text{src}} \leftarrow$ BoundingBox($\vect{v}_{\text{src}}$)
    \STATE $\text{BB}_{\text{dst}} \leftarrow$ BoundingBox($\vect{v}_{\text{dst}}$)
    \STATE \COMMENT{4b: Coordenadas locales}
    \STATE $\vect{v}_{\text{src}}^{\text{local}} \leftarrow \vect{v}_{\text{src}} - \text{BB}_{\text{src}}.\text{origen}$
    \STATE $\vect{v}_{\text{dst}}^{\text{local}} \leftarrow \vect{v}_{\text{dst}} - \text{BB}_{\text{dst}}.\text{origen}$
    \STATE \COMMENT{4c: Matriz de transformación afín}
    \STATE $M \leftarrow$ AffineTransform($\vect{v}_{\text{src}}^{\text{local}}$, $\vect{v}_{\text{dst}}^{\text{local}}$)
    \STATE \COMMENT{4d: Extraer y warpear parche}
    \STATE $\text{patch}_{\text{src}} \leftarrow I_{\text{src}}[\text{BB}_{\text{src}}]$
    \STATE $\text{patch}_{\text{warped}} \leftarrow$ WarpAffine($\text{patch}_{\text{src}}$, $M$, $\text{BB}_{\text{dst}}.\text{size}$)
    \STATE \COMMENT{4e: Crear máscara triangular}
    \STATE $\text{mask} \leftarrow$ TriangleMask($\vect{v}_{\text{dst}}^{\text{local}}$, $\text{BB}_{\text{dst}}.\text{size}$)
    \STATE \COMMENT{4f: Copiar con máscara}
    \STATE $I_{\text{dst}}[\text{BB}_{\text{dst}}][\text{mask}] \leftarrow \text{patch}_{\text{warped}}[\text{mask}]$
\ENDFOR
\RETURN $I_{\text{dst}}$
\end{algorithmic}
\end{algorithm}

\subsection{Detalles de Implementación}

\subsubsection{Interpolación}

Para el warpeo de cada triángulo se utiliza interpolación bilineal:

\begin{equation}
I(x, y) = (1-\alpha)(1-\beta)I_{00} + \alpha(1-\beta)I_{10} +
(1-\alpha)\beta I_{01} + \alpha\beta I_{11}
\end{equation}

donde $\alpha = x - \lfloor x \rfloor$ y $\beta = y - \lfloor y \rfloor$
son las partes fraccionales de las coordenadas.

\begin{observacion}[Elección de Interpolación]
Se eligió interpolación bilineal (cv2.INTER\_LINEAR) como compromiso entre:
\begin{itemize}
    \item Nearest neighbor: Rápido pero produce artefactos de ``escalera''
    \item Bilineal: Suave, eficiente, adecuado para la mayoría de aplicaciones
    \item Bicúbico: Más suave pero más costoso y puede producir ringing
\end{itemize}
\end{observacion}

\subsubsection{Manejo de Bordes}

Para píxeles cerca del borde de la imagen fuente, se utiliza el modo
REFLECT\_101 (reflexión sin duplicar el borde):

\begin{equation}
I(-1) = I(1), \quad I(-2) = I(2), \quad \ldots
\end{equation}

Esto evita artefactos de borde mientras preserva la estructura local.

\subsubsection{Validación de Triángulos}

Antes de procesar cada triángulo, se verifica que no sea degenerado:

\begin{equation}
|\det(T)| = |x_1(y_2 - y_3) + x_2(y_3 - y_1) + x_3(y_1 - y_2)| > \epsilon
\end{equation}

con $\epsilon = 10^{-6}$. Triángulos degenerados (colineales) se omiten.

% ==============================================================================
\section{Resultados Experimentales}
% ==============================================================================

\subsection{Configuración del Experimento}

\begin{table}[htbp]
\centering
\caption{Parámetros de configuración del warping}
\label{tab:warp_config}
\begin{tabular}{ll}
\toprule
\textbf{Parámetro} & \textbf{Valor} \\
\midrule
Imágenes procesadas & 96 (test set) \\
Landmarks por imagen & 15 anatómicos + 8 borde = 23 \\
Triángulos (original) & 18 \\
Triángulos (extendido) & $\sim$34 (variable) \\
Tamaño de entrada & 224 $\times$ 224 px \\
Tamaño de salida & 224 $\times$ 224 px \\
Interpolación & Bilineal (cv2.INTER\_LINEAR) \\
Modo de borde & REFLECT\_101 \\
Fuente de landmarks & Predicciones del modelo ensemble \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Métricas de Calidad del Warping}

\begin{table}[htbp]
\centering
\caption{Fill rate por categoría diagnóstica}
\label{tab:fill_rate_by_category}
\begin{tabular}{lccc}
\toprule
\textbf{Categoría} & \textbf{$n$} & \textbf{Fill Rate (\%)} & \textbf{Std (\%)} \\
\midrule
Normal & 47 & 96.3 & 1.2 \\
COVID-19 & 31 & 95.8 & 1.6 \\
Viral Pneumonia & 18 & 96.1 & 1.5 \\
\midrule
\textbf{Total} & \textbf{96} & \textbf{96.1} & \textbf{1.4} \\
\bottomrule
\end{tabular}
\end{table}

\begin{observacion}[Uniformidad del Fill Rate]
El fill rate es consistente entre categorías diagnósticas, lo cual indica
que:
\begin{enumerate}
    \item El modelo de landmarks predice con calidad similar en todas las categorías
    \item Las patologías no afectan significativamente la geometría detectable
    \item El warping no introduce sesgo por categoría
\end{enumerate}
\end{observacion}

\subsection{Comparación Visual}

\begin{table}[htbp]
\centering
\caption{Características de las imágenes warpeadas}
\label{tab:warped_characteristics}
\begin{tabular}{lcc}
\toprule
\textbf{Característica} & \textbf{Original} & \textbf{Warped} \\
\midrule
Posición del corazón & Variable & Consistente \\
Ancho del tórax & 150-200 px & $\sim$180 px \\
Altura del tórax & 140-180 px & $\sim$160 px \\
Eje central & $-5°$ a $+5°$ & $\sim 0°$ \\
Simetría bilateral & Variable & Mejorada \\
Ángulos costofrénicos & Posición variable & Posición fija \\
\bottomrule
\end{tabular}
\end{table}

% ==============================================================================
\section{Análisis Teórico de Propiedades}
% ==============================================================================

\subsection{Preservación de Estructuras}

\begin{teorema}[Preservación de Texturas]
El warping piecewise affine preserva las características texturales
locales de la imagen, incluyendo:
\begin{enumerate}
    \item Gradientes de intensidad
    \item Patrones de alta frecuencia (ruido, texturas finas)
    \item Bordes y contornos
\end{enumerate}
\end{teorema}

\begin{proof}[Argumento]
Cada triángulo se transforma mediante una función afín, que preserva
razones de distancias. Dentro de cada triángulo, las relaciones espaciales
entre píxeles se mantienen (salvo el factor de escala y rotación de la
transformación afín).

Los patrones de textura, que dependen de la autocorrelación espacial local,
se preservan porque:
\begin{equation}
\text{Cov}(I(\vect{x}), I(\vect{x} + \Delta\vect{x})) \approx
\text{Cov}(I'(A\vect{x}), I'(A(\vect{x} + \Delta\vect{x})))
\end{equation}
\end{proof}

\begin{corolario}[Preservación de Patología]
Las consolidaciones pulmonares, opacidades, infiltrados y otras
características patológicas visibles en las radiografías se preservan
después del warping, ya que son patrones de textura/intensidad que no
dependen de la geometría global.
\end{corolario}

\subsection{Análisis de Error}

\begin{proposicion}[Propagación de Error de Landmarks]
Sea $\epsilon_L$ el error medio en la predicción de landmarks
(en píxeles). El error en la posición de un píxel warpeado está acotado por:
\begin{equation}
\epsilon_W \leq \sqrt{2} \cdot \epsilon_L \cdot \max_i \|A_i\|_2
\end{equation}
donde $A_i$ es la matriz de la transformación afín del triángulo que
contiene el píxel.
\end{proposicion}

\begin{proof}
Para un punto $\vect{x}$ en el triángulo $T_i$ con transformación $\mathcal{A}_i$:
\begin{equation}
\vect{x}' = A_i\vect{x} + \vect{t}_i
\end{equation}

Si los landmarks tienen error $\delta L$, la transformación estimada
$\hat{\mathcal{A}}_i$ difiere de la real. El error en la posición
del píxel transformado es:
\begin{equation}
\|\hat{\vect{x}}' - \vect{x}'\| \leq \|A_i\| \cdot \|\delta\vect{x}\| +
\|\delta\vect{t}_i\|
\end{equation}

El error en la traslación está dominado por el error en los landmarks,
y $\|\delta\vect{x}\|$ está acotado por el error en las coordenadas
baricéntricas multiplicado por el tamaño del triángulo.
\end{proof}

\begin{observacion}[Error Práctico]
Con un error de landmarks de $\epsilon_L \approx 3.71$ px (nuestro mejor
modelo) y transformaciones afines con norma típica $\|A\|_2 \approx 1.2$,
el error esperado en la posición de píxeles es:
\begin{equation}
\epsilon_W \lesssim 1.41 \times 3.71 \times 1.2 \approx 6.3 \text{ px}
\end{equation}
Este error es aceptable para una imagen de 224×224 px.
\end{observacion}

% ==============================================================================
\section{Figuras Sugeridas}
% ==============================================================================

\subsection{Figura 11.1: Triangulación de Delaunay sobre Forma Canónica}

\begin{figuradescripcion}
\textbf{Título}: Triangulación de Delaunay sobre 15 landmarks anatómicos

\textbf{Contenido}: Visualización de los 18 triángulos sobre la forma
canónica en un canvas de 224×224 píxeles.

\textbf{Elementos visuales}:
\begin{itemize}
    \item Triángulos con bordes en azul semitransparente
    \item Landmarks como puntos rojos numerados (L1-L15)
    \item Eje central (L1-L2) en línea roja más gruesa
    \item Pares bilaterales conectados con líneas punteadas verdes
\end{itemize}

\textbf{Anotación}: Indicar que esta triangulación cubre solo ~47\% de la imagen.
\end{figuradescripcion}

\subsection{Figura 11.2: Triangulación Extendida con Puntos de Borde}

\begin{figuradescripcion}
\textbf{Título}: Triangulación extendida con 8 puntos de borde adicionales

\textbf{Contenido}: Visualización de la triangulación extendida sobre 23 puntos.

\textbf{Elementos visuales}:
\begin{itemize}
    \item 15 landmarks anatómicos en rojo
    \item 8 puntos de borde en amarillo (4 esquinas + 4 medios)
    \item Todos los triángulos en azul semitransparente
    \item Diferenciación visual entre triángulos ``interiores'' y de ``borde''
\end{itemize}

\textbf{Contraste}: Mostrar lado a lado con Figura 11.1 para contrastar cobertura.
\end{figuradescripcion}

\subsection{Figura 11.3: Proceso de Warping Triángulo por Triángulo}

\begin{figuradescripcion}
\textbf{Título}: Warping piecewise affine: transformación por triángulos

\textbf{Contenido}: Diagrama conceptual del proceso de warping.

\textbf{Elementos visuales}:
\begin{itemize}
    \item Imagen original con un triángulo resaltado
    \item Flecha indicando transformación afín
    \item Imagen destino con triángulo correspondiente
    \item Ecuaciones de la transformación afín
\end{itemize}

\textbf{Subpaneles}:
\begin{enumerate}
    \item Extracción de bounding box
    \item Cálculo de matriz afín
    \item Aplicación de warp
    \item Enmascaramiento y composición
\end{enumerate}
\end{figuradescripcion}

\subsection{Figura 11.4: Comparación Antes/Después del Warping}

\begin{figuradescripcion}
\textbf{Título}: Normalización geométrica: ejemplos por categoría

\textbf{Contenido}: Grilla de 3 filas (Normal, COVID, Viral) × 4 columnas:
\begin{enumerate}
    \item Original
    \item Original + landmarks predichos
    \item Warped
    \item Warped + forma canónica
\end{enumerate}

\textbf{Elementos visuales}:
\begin{itemize}
    \item Landmarks predichos en rojo
    \item Landmarks canónicos en verde
    \item Conexiones anatómicas superpuestas
\end{itemize}

\textbf{Mensaje}: Demostrar que diferentes anatomías convergen a la misma forma.
\end{figuradescripcion}

\subsection{Figura 11.5: Histograma de Fill Rates}

\begin{figuradescripcion}
\textbf{Título}: Distribución de fill rates en el test set

\textbf{Contenido}: Histograma de fill rates para las 96 imágenes.

\textbf{Elementos visuales}:
\begin{itemize}
    \item Barras del histograma (20 bins)
    \item Línea vertical punteada en la media (96.1\%)
    \item Anotación con estadísticas: media, std, min, max
\end{itemize}

\textbf{Coloreado opcional}: Barras coloreadas por categoría para mostrar uniformidad.
\end{figuradescripcion}

\subsection{Figura 11.6: Correspondencia de Landmarks}

\begin{figuradescripcion}
\textbf{Título}: Correspondencia de landmarks entre forma original y canónica

\textbf{Contenido}: Visualización de vectores de desplazamiento de landmarks.

\textbf{Elementos visuales}:
\begin{itemize}
    \item Imagen compuesta (mezcla rojo/verde de original y warped)
    \item Vectores (flechas) conectando cada landmark original con su posición canónica
    \item Landmarks originales en rojo, canónicos en verde
\end{itemize}

\textbf{Mensaje}: Mostrar la magnitud y dirección de las deformaciones aplicadas.
\end{figuradescripcion}

% ==============================================================================
\section{Archivos Fuente y Reproducibilidad}
% ==============================================================================

\begin{table}[htbp]
\centering
\caption{Archivos de implementación del warping piecewise affine}
\label{tab:warp_source_files}
\begin{tabular}{p{5.5cm}p{7.5cm}}
\toprule
\textbf{Archivo} & \textbf{Contenido} \\
\midrule
\archivo{scripts/piecewise\_affine\_warp.py} & Implementación completa:\\
& \quad - \texttt{get\_affine\_transform\_matrix()}: Matriz afín entre triángulos\\
& \quad - \texttt{warp\_triangle()}: Warping de un triángulo\\
& \quad - \texttt{add\_boundary\_points()}: Extensión con 8 puntos de borde\\
& \quad - \texttt{piecewise\_affine\_warp()}: Warping completo\\
& \quad - \texttt{normalize\_image\_geometry()}: Interfaz de alto nivel\\
\midrule
\archivo{scripts/landmark\_connections.py} & Definición de conexiones anatómicas:\\
& \quad - EJE\_CENTRAL, PULMON\_IZQUIERDO, PULMON\_DERECHO\\
\midrule
\archivo{outputs/shape\_analysis/\\canonical\_delaunay\_triangles.json} & Triangulación Delaunay:\\
& \quad - 18 triángulos (índices de vértices)\\
& \quad - Coordenadas de landmarks canónicos\\
\midrule
\archivo{outputs/shape\_analysis/warped/} & Resultados del warping:\\
& \quad - \texttt{warped\_test\_images.npz}: Imágenes warpeadas\\
& \quad - \texttt{warp\_config.json}: Configuración\\
& \quad - Visualizaciones de ejemplo\\
\bottomrule
\end{tabular}
\end{table}

% ==============================================================================
\section{Discusión}
% ==============================================================================

\subsection{Ventajas del Enfoque}

\begin{enumerate}
    \item \textbf{Preservación de información clínica}: Las características
    patológicas (consolidaciones, opacidades) se preservan mientras la
    geometría se normaliza

    \item \textbf{Eficiencia computacional}: El warping es $O(n)$ en el
    número de píxeles, ejecutándose en milisegundos por imagen

    \item \textbf{Continuidad garantizada}: La continuidad en bordes de
    triángulos está garantizada matemáticamente (Teorema \ref{thm:boundary_continuity})

    \item \textbf{Control explícito}: Los landmarks anatómicos proporcionan
    puntos de control semánticamente significativos
\end{enumerate}

\subsection{Limitaciones}

\begin{enumerate}
    \item \textbf{Dependencia de calidad de landmarks}: El warping propaga
    errores de las predicciones de landmarks

    \item \textbf{Discontinuidad $C^1$}: El gradiente de la imagen puede
    ser discontinuo en los bordes de triángulos

    \item \textbf{Artefactos en triángulos muy deformados}: Si un triángulo
    se deforma significativamente, pueden aparecer artefactos de interpolación

    \item \textbf{Regiones fuera de la envolvente convexa}: Los puntos de
    borde son necesarios para cobertura completa
\end{enumerate}

\subsection{Alternativas Consideradas}

\begin{table}[htbp]
\centering
\caption{Comparación con métodos alternativos de warping}
\label{tab:warp_alternatives}
\begin{tabular}{p{3cm}p{4cm}p{4cm}}
\toprule
\textbf{Método} & \textbf{Ventajas} & \textbf{Desventajas} \\
\midrule
Thin Plate Splines & Suavidad global, $C^2$ & Computacionalmente costoso, puede sobre-suavizar \\
Moving Least Squares & Deformaciones muy suaves & Costoso, menos control local \\
Piecewise Affine (elegido) & Eficiente, control local, continuidad $C^0$ & Discontinuidad en gradientes \\
Homografía global & Simple & No captura deformaciones locales \\
\bottomrule
\end{tabular}
\end{table}

% ==============================================================================
\section{Conclusiones}
% ==============================================================================

\begin{enumerate}
    \item \textbf{Warping piecewise affine es efectivo}: La técnica permite
    normalizar la geometría de radiografías de tórax preservando las
    características patológicas relevantes para clasificación.

    \item \textbf{La extensión de dominio es necesaria}: Agregar 8 puntos
    de borde aumenta el fill rate del 47.1\% al 96.1\%, garantizando
    cobertura casi completa de la imagen.

    \item \textbf{La triangulación de Delaunay es óptima}: Produce
    triángulos bien condicionados que minimizan artefactos de warping.

    \item \textbf{El pipeline es end-to-end}: Utilizando landmarks predichos
    por el modelo, el sistema puede normalizar imágenes sin intervención
    manual en tiempo de inferencia.

    \item \textbf{La continuidad $C^0$ es suficiente}: Para la aplicación
    de clasificación de imágenes, la continuidad en bordes de triángulos
    es adecuada; no se requiere suavidad $C^1$.

    \item \textbf{El método es computacionalmente eficiente}: El warping
    de una imagen de 224×224 toma menos de 50ms, permitiendo su uso en
    pipelines de producción.
\end{enumerate}

\end{document}
