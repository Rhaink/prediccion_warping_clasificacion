% =============================================================================
% APENDICE B: CONFIGURACION COMPLETA DE HIPERPARAMETROS
% =============================================================================

\chapter{Configuracion Completa de Hiperparametros}
\label{ap:hiperparametros}

Este apendice documenta la configuracion completa del sistema final, incluyendo todos los hiperparametros utilizados para el modelo, preprocesamiento, entrenamiento e inferencia.

% -----------------------------------------------------------------------------
\section{Configuracion en Formato JSON}
\label{sec:ap_json}
% -----------------------------------------------------------------------------

\begin{lstlisting}[caption={Configuracion final del sistema (configs/final\_config.json)},label={lst:ap_config},language={}]
{
  "model": {
    "architecture": {
      "backbone": "resnet18",
      "pretrained": true,
      "coord_attention": true,
      "coord_attention_reduction": 32,
      "deep_head": true,
      "hidden_dim": 768,
      "dropout": 0.3,
      "output_activation": "sigmoid"
    },
    "num_landmarks": 15,
    "output_dim": 30
  },

  "preprocessing": {
    "input_size": {
      "original": [299, 299],
      "model_input": [224, 224]
    },
    "clahe": {
      "enabled": true,
      "clip_limit": 2.0,
      "tile_size": 4,
      "color_space": "LAB"
    },
    "normalization": {
      "type": "imagenet",
      "mean": [0.485, 0.456, 0.406],
      "std": [0.229, 0.224, 0.225]
    },
    "coordinate_normalization": {
      "method": "min_max",
      "range": [0, 1],
      "reference_size": 299
    }
  },

  "augmentation": {
    "train": {
      "horizontal_flip": {
        "enabled": true,
        "probability": 0.5,
        "symmetric_pairs": [[2,3], [4,5], [6,7], [11,12], [13,14]]
      },
      "rotation": {
        "enabled": true,
        "max_degrees": 10
      },
      "color_jitter": {
        "enabled": true,
        "brightness": 0.2,
        "contrast": 0.2,
        "saturation": 0,
        "hue": 0
      }
    },
    "val_test": {
      "horizontal_flip": false,
      "rotation": false,
      "color_jitter": false
    }
  },

  "training": {
    "phase1": {
      "description": "Feature extraction - backbone frozen",
      "epochs": 15,
      "batch_size": 16,
      "backbone_frozen": true,
      "optimizer": {
        "type": "Adam",
        "lr": 0.001,
        "weight_decay": 0
      },
      "scheduler": {
        "type": "StepLR",
        "step_size": 5,
        "gamma": 0.5
      },
      "early_stopping": {
        "patience": 5,
        "min_delta": 0.01
      }
    },
    "phase2": {
      "description": "Fine-tuning - full network",
      "epochs": 100,
      "batch_size": 8,
      "backbone_frozen": false,
      "optimizer": {
        "type": "Adam",
        "backbone_lr": 2e-5,
        "attention_lr": 2e-5,
        "head_lr": 2e-4,
        "weight_decay": 0
      },
      "scheduler": {
        "type": "CosineAnnealingLR",
        "T_max": 100,
        "eta_min": 1e-6
      },
      "early_stopping": {
        "patience": 15,
        "min_delta": 0.01
      }
    },
    "loss": {
      "type": "WingLoss",
      "omega": 10,
      "epsilon": 2,
      "normalized": true
    }
  },

  "inference": {
    "tta": {
      "enabled": true,
      "augmentations": ["original", "horizontal_flip"]
    },
    "ensemble": {
      "enabled": true,
      "num_models": 4,
      "seeds": [123, 456, 321, 789],
      "aggregation": "mean",
      "excluded_seeds": [42]
    }
  },

  "data": {
    "split": {
      "train": 0.749,
      "val": 0.150,
      "test": 0.101
    },
    "stratified": true,
    "random_seed": 42
  },

  "hardware": {
    "gpu": "AMD Radeon RX 6600",
    "vram": "8 GB",
    "framework": "PyTorch 2.0+",
    "backend": "ROCm"
  },

  "results": {
    "baseline_error_px": 9.08,
    "final_error_px": 3.71,
    "improvement_percent": 59,
    "by_category": {
      "Normal": 3.50,
      "COVID-19": 3.80,
      "Viral_Pneumonia": 4.35
    }
  }
}
\end{lstlisting}

% -----------------------------------------------------------------------------
\section{Resumen Tabular de Hiperparametros}
\label{sec:ap_tabla_hiper}
% -----------------------------------------------------------------------------

\subsection{Arquitectura del Modelo}

\begin{table}[htbp]
    \centering
    \caption{Hiperparametros de arquitectura}
    \label{tab:ap_arch}
    \begin{tabular}{@{}llp{6cm}@{}}
        \toprule
        \textbf{Parametro} & \textbf{Valor} & \textbf{Justificacion} \\
        \midrule
        Backbone & ResNet-18 & Balance precision-eficiencia \\
        Pretrained & True & Transfer learning de ImageNet \\
        Coord Attention & True & Mejora localizacion espacial \\
        Reduction & 32 & Valor por defecto del paper \\
        Deep Head & True & Mayor capacidad de regresion \\
        Hidden Dim & 768 & Optimo experimental (S9) \\
        Dropout & 0.3 & Balance regularizacion-capacidad \\
        Output & Sigmoid & Normaliza a [0, 1] \\
        \bottomrule
    \end{tabular}
\end{table}

\subsection{Preprocesamiento}

\begin{table}[htbp]
    \centering
    \caption{Hiperparametros de preprocesamiento}
    \label{tab:ap_preproc}
    \begin{tabular}{@{}llp{6cm}@{}}
        \toprule
        \textbf{Parametro} & \textbf{Valor} & \textbf{Justificacion} \\
        \midrule
        Tamano entrada & 224 $\times$ 224 & Estandar ImageNet \\
        CLAHE clip & 2.0 & Optimo experimental (S8) \\
        CLAHE tile & 4 & Realce local fino \\
        Color space & LAB & Mejor que RGB para CLAHE \\
        Normalizacion & ImageNet & Compatibilidad con pesos \\
        \bottomrule
    \end{tabular}
\end{table}

\subsection{Entrenamiento}

\begin{table}[htbp]
    \centering
    \caption{Hiperparametros de entrenamiento}
    \label{tab:ap_train}
    \begin{tabular}{@{}lcc@{}}
        \toprule
        \textbf{Parametro} & \textbf{Fase 1} & \textbf{Fase 2} \\
        \midrule
        Epocas & 15 & 100 \\
        Batch size & 16 & 8 \\
        LR backbone & N/A & $2 \times 10^{-5}$ \\
        LR head & $10^{-3}$ & $2 \times 10^{-4}$ \\
        Optimizer & Adam & Adam \\
        Scheduler & StepLR & CosineAnnealing \\
        Patience & 5 & 15 \\
        \bottomrule
    \end{tabular}
\end{table}

\subsection{Data Augmentation}

\begin{table}[htbp]
    \centering
    \caption{Hiperparametros de data augmentation}
    \label{tab:ap_aug}
    \begin{tabular}{@{}llc@{}}
        \toprule
        \textbf{Augmentation} & \textbf{Parametro} & \textbf{Valor} \\
        \midrule
        Horizontal Flip & Probabilidad & 0.5 \\
        Rotation & Rango & $\pm 10\degree$ \\
        Brightness & Rango & $\pm 20\%$ \\
        Contrast & Rango & $\pm 20\%$ \\
        \bottomrule
    \end{tabular}
\end{table}

% -----------------------------------------------------------------------------
\section{Checkpoints del Ensemble Final}
\label{sec:ap_checkpoints}
% -----------------------------------------------------------------------------

\begin{table}[htbp]
    \centering
    \caption{Modelos del ensemble final}
    \label{tab:ap_checkpoints}
    \begin{tabular}{@{}clcc@{}}
        \toprule
        \textbf{Modelo} & \textbf{Ruta} & \textbf{Seed} & \textbf{Error (px)} \\
        \midrule
        1 & session10/ensemble/seed123/final\_model.pt & 123 & 4.05 \\
        2 & session10/ensemble/seed456/final\_model.pt & 456 & 4.04 \\
        3 & session13/seed321/final\_model.pt & 321 & 4.23 \\
        4 & session13/seed789/final\_model.pt & 789 & 4.37 \\
        \midrule
        \multicolumn{2}{l}{\textbf{Ensemble (promedio)}} & - & \textbf{3.71} \\
        \bottomrule
    \end{tabular}
\end{table}

% -----------------------------------------------------------------------------
\section{Comando de Entrenamiento}
\label{sec:ap_comando}
% -----------------------------------------------------------------------------

\begin{lstlisting}[caption={Comando para entrenar un modelo},label={lst:ap_train_cmd},language=bash]
python scripts/train.py \
    --seed 123 \
    --clahe \
    --clahe-clip 2.0 \
    --clahe-tile 4 \
    --coord-attention \
    --deep-head \
    --hidden-dim 768 \
    --dropout 0.3 \
    --epochs 100 \
    --patience 15 \
    --batch-size-phase1 16 \
    --batch-size-phase2 8 \
    --lr-backbone 2e-5 \
    --lr-head 2e-4 \
    --loss wing \
    --output-dir checkpoints/my_model
\end{lstlisting}

% -----------------------------------------------------------------------------
% FIN DEL APENDICE
% -----------------------------------------------------------------------------
