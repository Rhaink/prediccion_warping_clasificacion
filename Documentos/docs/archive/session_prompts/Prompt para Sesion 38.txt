# SESION 38 - VALIDACION EXPERIMENTAL POST-INTROSPECCION

NOTA (2025-12-21): outputs/full_coverage_warped_dataset y outputs/classifier_warped_full_coverage fueron invalidados.
Este prompt queda como referencia historica (ver docs/reportes/RESUMEN_DEPURACION_OUTPUTS.md).

## CONTEXTO CRITICO (LEE ESTO PRIMERO)

Esta sesión continúa después de una **introspección crítica multiagente** (Sesión 37) que identificó problemas metodológicos importantes. El proyecto tiene datos REALES pero la narrativa científica requiere REFORMULACIÓN.

**Estado del Proyecto:** ~90% completo
**Branch:** feature/restructure-production
**Deadline:** < 1 mes para entrega de tesis

---

## HALLAZGOS CRITICOS DE SESION 37

### H1: HIPOTESIS "ELIMINA MARCAS" - NO DEMOSTRADA
```
❌ INCORRECTO: "El warping elimina marcas hospitalarias"
✅ CORRECTO:   "El warping RECORTA/EXCLUYE marcas del campo de vista"
```
**Evidencia:** El análisis visual muestra que las marcas quedan FUERA del crop geométrico, no que se "eliminen" activamente.

### H2: CROSS-EVALUATION TIENE SESGO METODOLOGICO
```
Original → Warped: Gap 25.36% (modelo pierde 53% de información)
Warped → Original: Gap 2.24% (modelo gana información nueva)
```
**El gap de 25.36% NO mide overfitting, mide PÉRDIDA DE INFORMACIÓN**

Comparación actual era INJUSTA:
- Dataset original: 100% información
- Dataset warped (anterior): 47% información

**AHORA TENEMOS:** Dataset full_coverage con 99.11% información

### H3: PFS ERA INVALIDO (AHORA CORREGIBLE)
Las máscaras pulmonares NO se transformaban con las imágenes:
- Imagen warped: 224x224
- Máscara original: 299x299
- **DESALINEACIÓN GEOMÉTRICA**

**SOLUCION IMPLEMENTADA:** `warp_mask()` ya está disponible en `src_v2/processing/warp.py`

### H4: LO QUE SÍ ESTÁ VALIDADO
| Claim | Estado | Confianza |
|-------|--------|-----------|
| Robustez JPEG 30x | VÁLIDO | 99% |
| Robustez Blur 3x | VÁLIDO | 99% |
| Datos experimentales | REALES | 99% |
| CLI funcional | VÁLIDO | 100% |

---

## RECURSOS DISPONIBLES (YA GENERADOS)

### 1. Dataset Full Coverage
```
outputs/full_coverage_warped_dataset/
├── train/  (11,364 imágenes)
├── val/    (1,894 imágenes)
├── test/   (1,895 imágenes)
└── dataset_summary.json

Fill rate: 99.11% (vs 47% anterior)
Total: 15,153 imágenes
```

### 2. Función warp_mask()
```python
from src_v2.processing.warp import warp_mask

# Transforma máscaras con misma geometría que imágenes
warped_mask = warp_mask(
    mask=lung_mask,
    source_landmarks=predicted_landmarks,
    target_landmarks=canonical_landmarks,
    use_full_coverage=True
)
```

### 3. Análisis Visual
```
outputs/visual_analysis/
├── comparison_01_COVID__*.png (6 archivos)
└── hospital_marks_mosaic_full_coverage.png
```

### 4. Documentación
- `docs/sesiones/SESION_37_INTROSPECCION_MULTIAGENTE.md`
- `Prompt para Sesion 38.txt` (este archivo)

---

## OBJETIVOS SESION 38 (EN ORDEN DE PRIORIDAD)

### PRIORIDAD 1: Re-entrenar Clasificador con Full Coverage
```bash
# Este es el experimento MÁS IMPORTANTE
.venv/bin/python -m src_v2 train-classifier \
    --data-dir outputs/full_coverage_warped_dataset \
    --output-dir outputs/classifier_warped_full_coverage \
    --epochs 50 \
    --batch-size 32
```

**Objetivo:** Obtener modelo entrenado con información simétrica (99% fill rate)

### PRIORIDAD 2: Re-ejecutar Cross-Evaluation JUSTA
```bash
# Después de entrenar el nuevo clasificador
.venv/bin/python -m src_v2 cross-evaluate \
    --original-model outputs/classifier_original/best_model.pt \
    --warped-model outputs/classifier_warped_full_coverage/best_model.pt \
    --original-data data/dataset/COVID-19_Radiography_Dataset \
    --warped-data outputs/full_coverage_warped_dataset \
    --output-dir outputs/cross_evaluation_fair
```

**Objetivo:** Comparar modelos con MISMA cantidad de información

### PRIORIDAD 3: Recalcular PFS con Máscaras Warped
```python
# Script para recalcular PFS válido
from src_v2.processing.warp import warp_mask, piecewise_affine_warp

# Para cada imagen y máscara:
warped_img = piecewise_affine_warp(img, src_lm, dst_lm, use_full_coverage=True)
warped_mask = warp_mask(mask, src_lm, dst_lm, use_full_coverage=True)

# Ahora PFS es válido (geometría alineada)
pfs = calculate_pfs(warped_img, warped_mask)
```

### PRIORIDAD 4: Documentar Resultados Reformulados
Actualizar `docs/RESULTADOS_EXPERIMENTALES_v2.md` con:
- Resultados del nuevo clasificador
- Cross-evaluation justa
- PFS válido
- Narrativa reformulada

---

## COMANDOS UTILES

```bash
# Verificar estado del proyecto
git status
git log --oneline -5

# Verificar CLI funciona
.venv/bin/python -m src_v2 --help

# Correr tests
.venv/bin/python -m pytest tests/test_processing.py -v --tb=short

# Ver resumen del dataset full_coverage
cat outputs/full_coverage_warped_dataset/dataset_summary.json

# Entrenar clasificador (comando principal)
.venv/bin/python -m src_v2 train-classifier --help

# Ver checkpoints disponibles
ls -la checkpoints/
ls -la outputs/
```

---

## COMMITS RECIENTES

```
dd2bfb4 fix: clamp bounding box to max_size in get_bounding_box
827c041 feat: implementar warp_mask() y generar dataset full_coverage
a8732a4 docs: agregar introspeccion critica sesion 36
a67e54c docs: agregar resultados reformulados y script full_coverage
11fb902 fix: corregir imports de warping en CLI
```

---

## REFORMULACION DE NARRATIVA (USAR EN DOCUMENTACION)

### ANTES (Problemático):
> "La normalización geométrica elimina marcas hospitalarias y generaliza 11x mejor"

### DESPUES (Científicamente Preciso):
> "La normalización geométrica mediante landmarks anatómicos proporciona:
>
> **Robustez significativamente superior:**
> - 30x más robusto a compresión JPEG (degradación 0.53% vs 16.14%)
> - 3x más robusto a blur gaussiano (degradación 16.27% vs 46.05%)
>
> **Trade-offs identificados:**
> - Reducción de accuracy en dominio interno: -0.8% (98.02% vs 98.81%)
>
> **Mecanismo propuesto:**
> La mejora proviene de la concentración del modelo en regiones anatómicas centrales y la reducción de información no-anatómica (marcas hospitalarias, bordes, artefactos)."

---

## PREGUNTAS PARA RESPONDER EN SESION 38

1. **¿El modelo full_coverage mantiene la robustez?**
   - Hipótesis: Sí, porque full_coverage preserva la normalización geométrica
   - Verificar: Test de robustez JPEG/Blur

2. **¿El cross-evaluation justo muestra generalización real?**
   - Hipótesis: Los gaps serán más simétricos
   - Si el modelo warped sigue generalizando mejor → evidencia real

3. **¿Qué muestra el PFS válido?**
   - Hipótesis: El modelo warped debería enfocar más en pulmones
   - Si PFS es similar → la hipótesis de "foco pulmonar" no se sostiene

4. **¿Podemos publicar estos resultados?**
   - Robustez: SÍ (dato más sólido)
   - Generalización: DEPENDE de cross-evaluation justa
   - Eliminación de marcas: NO sin análisis cuantitativo adicional

---

## ESTRUCTURA DE ARCHIVOS CLAVE

```
prediccion_warping_clasificacion/
├── src_v2/
│   ├── cli.py                    # CLI principal (20 comandos)
│   └── processing/
│       └── warp.py               # warp_mask(), piecewise_affine_warp()
├── scripts/
│   ├── analyze_hospital_marks.py # Análisis visual
│   └── generate_warped_dataset_full_coverage.py
├── outputs/
│   ├── full_coverage_warped_dataset/  # NUEVO: 99% fill
│   ├── full_warped_dataset/           # ANTERIOR: 47% fill
│   └── visual_analysis/               # Comparaciones visuales
├── docs/
│   ├── sesiones/
│   │   └── SESION_37_INTROSPECCION_MULTIAGENTE.md
│   └── RESULTADOS_EXPERIMENTALES_v2.md
└── tests/
    └── test_processing.py        # 74 tests (6 nuevos de warp_mask)
```

---

## TIPS PARA MEJORES RESULTADOS

1. **Usar agentes para tareas largas:** El entrenamiento de clasificador puede tomar tiempo. Considera ejecutarlo en background.

2. **Verificar antes de experimentar:** Siempre corre `pytest` antes de experimentos largos para asegurar que el código funciona.

3. **Documentar resultados inmediatamente:** Cada experimento debe documentarse antes de pasar al siguiente.

4. **No fabricar datos:** Si un experimento no sale como esperabas, documéntalo honestamente. Los resultados negativos también son valiosos.

5. **Enfocar en robustez:** Este es el resultado más sólido del proyecto. Priorízalo en la narrativa.

---

## ESTADO FINAL DEL TODO LIST

- [x] Dataset full_coverage generado (99.11% fill)
- [x] warp_mask() implementado y testeado
- [x] Análisis visual generado
- [x] Bug get_bounding_box corregido
- [x] Documentación de introspección creada
- [ ] **Entrenar clasificador con full_coverage** ← PRIORIDAD 1
- [ ] **Cross-evaluation justa** ← PRIORIDAD 2
- [ ] **Recalcular PFS válido** ← PRIORIDAD 3
- [ ] Reformular documentación de tesis
- [ ] Experimento de control (original cropped)

---

## COMO INICIAR LA SESION

**Copia y pega esto al inicio de la conversación:**

```
Continúo trabajo en mi tesis de clasificación COVID-19 con normalización geométrica.

CONTEXTO CRÍTICO (de Sesión 37):
- Dataset full_coverage generado: 15,153 imágenes, 99.11% fill rate
- warp_mask() implementado para PFS válido
- Hipótesis "elimina marcas" NO DEMOSTRADA (solo recorta)
- Cross-evaluation anterior tenía sesgo (47% vs 100% información)

OBJETIVO HOY:
1. Entrenar clasificador con dataset full_coverage
2. Re-ejecutar cross-evaluation con información simétrica
3. Verificar si la robustez se mantiene

El prompt completo está en: Prompt para Sesion 38.txt
La documentación de hallazgos está en: docs/sesiones/SESION_37_INTROSPECCION_MULTIAGENTE.md

¿Empezamos con el entrenamiento del clasificador?
```

---

## METRICAS DE EXITO PARA SESION 38

| Métrica | Objetivo | Método de Verificación |
|---------|----------|------------------------|
| Clasificador entrenado | Accuracy > 95% | Evaluar en test set |
| Cross-evaluation | Gaps < 10% ambos lados | Comparar Original↔Warped |
| Robustez JPEG | Degradación < 2% | Test de robustez |
| Robustez Blur | Degradación < 20% | Test de robustez |
| PFS válido | Calculado correctamente | Verificar alineación geométrica |
| Documentación | Actualizada | Review manual |

---

**Creado:** 10 Diciembre 2025
**Última actualización:** Sesión 37 post-introspección multiagente
**Próxima revisión:** Sesión 38
