# SESION 39 - EXPERIMENTO DE CONTROL CRITICO

## CONTEXTO CRITICO (LEE ESTO PRIMERO)

Esta sesion continua despues de **hallazgos metodologicos importantes** en Sesion 38 que requieren validacion experimental urgente.

**Estado del Proyecto:** ~90% completo
**Branch:** feature/restructure-production
**Deadline:** < 1 mes para entrega de tesis

---

## HALLAZGO PRINCIPAL DE SESION 38

### LA ROBUSTEZ DESAPARECE CON FULL COVERAGE

```
Modelo warped 47% fill:  0.53% degradacion JPEG Q50  (MUY ROBUSTO)
Modelo warped 99% fill:  7.34% degradacion JPEG Q50  (NO ROBUSTO)
                         ↑
                    13.8x PEOR
```

**INTERPRETACION:** La robustez NO viene de normalizacion geometrica, sino de REDUCCION DE INFORMACION (47% de pixeles = 53% fondo negro = regularizacion implicita).

**ESTADO:** Hipotesis, requiere CONFIRMACION con experimento de control.

---

## ESTADO ACTUAL VERIFICADO

### Datos 100% Reales (Verificado por 5 agentes)
- Clasificador full_coverage: 98.73% accuracy (REAL)
- Robustez JPEG Q50: 7.34% degradacion (REAL)
- Dataset full_coverage: 15,153 imagenes, 99.11% fill rate (REAL)
- CLI: 21 comandos funcionando (VERIFICADO)
- Tests: 74 pasando, 78% cobertura (VERIFICADO)

### Problemas Metodologicos Identificados
1. Cross-evaluation INVALIDO (4 clases vs 3 clases)
2. PFS calculado con mascaras no warped (INVALIDO)
3. Claim "elimina marcas" NO CUANTIFICADO
4. Mecanismo de robustez NO CONFIRMADO

---

## OBJETIVO PRINCIPAL SESION 39

### EXPERIMENTO DE CONTROL: Original Cropped 47%

**Proposito:** Distinguir si la robustez viene de:
- A) Reduccion de informacion (47% fill = regularizacion)
- B) Normalizacion geometrica (alineacion anatomica)

**Logica del experimento:**
- Crear dataset ORIGINAL (sin warping) pero con CROP al 47% fill rate
- Entrenar clasificador en este dataset
- Medir robustez JPEG/Blur

**Interpretacion de resultados:**
```
SI Original Cropped 47% ES ROBUSTO:
  → Robustez = REDUCCION DE INFORMACION
  → Hipotesis de normalizacion REFUTADA
  → Reformular tesis como "trade-off info vs robustez"

SI Original Cropped 47% NO ES ROBUSTO:
  → Robustez = NORMALIZACION GEOMETRICA
  → Hipotesis original CONFIRMADA
  → Mantener narrativa de "warping mejora robustez"
```

---

## RECURSOS DISPONIBLES

### Modelos Entrenados
```
outputs/classifier_original/best_classifier_original.pt     # Original (957 imgs)
outputs/classifier_warped_full_coverage/best_classifier.pt  # Warped 99% fill
outputs/classifier/                                         # Warped 47% fill (anterior)
```

### Datasets
```
data/dataset/COVID-19_Radiography_Dataset/  # Original (4 clases, 42K imgs)
outputs/full_coverage_warped_dataset/       # Warped 99% fill (15,153 imgs)
outputs/warped_dataset/                     # Warped 47% fill (957 imgs)
```

### Resultados de Robustez
```
outputs/robustness_warped_full_coverage.json           # Warped 99% fill
outputs/session29_robustness/artifact_robustness_results.json  # Warped 47% fill
```

### Documentacion
```
docs/sesiones/SESION_38_VALIDACION_EXPERIMENTAL.md
docs/sesiones/SESION_38_INTROSPECCION_PROFUNDA.md
docs/sesiones/SESION_37_INTROSPECCION_MULTIAGENTE.md
```

---

## TAREAS SESION 39 (EN ORDEN DE PRIORIDAD)

### PRIORIDAD 1: Experimento de Control (4-5 horas)

**Paso 1:** Crear script para generar dataset Original Cropped
```python
# Necesitamos un script que:
# 1. Tome imagenes originales
# 2. Aplique crop central al 47% fill rate (SIN warping)
# 3. Mantenga estructura train/val/test
# 4. Guarde en outputs/original_cropped_47/
```

**Paso 2:** Entrenar clasificador
```bash
.venv/bin/python -m src_v2 train-classifier \
    outputs/original_cropped_47 \
    --output-dir outputs/classifier_original_cropped_47 \
    --epochs 50 --batch-size 32
```

**Paso 3:** Test de robustez
```bash
.venv/bin/python -m src_v2 test-robustness \
    outputs/classifier_original_cropped_47/best_classifier.pt \
    --data-dir outputs/original_cropped_47 \
    --output outputs/robustness_original_cropped_47.json
```

**Paso 4:** Comparar resultados
```
                        JPEG Q50 degradacion
Original 100%:          16.14%
Warped 47% fill:        0.53%
Warped 99% fill:        7.34%
Original Cropped 47%:   ???  ← ESTE ES EL DATO CRITICO
```

### PRIORIDAD 2: Cross-Evaluation Valido (2-3 horas)

**Paso 1:** Filtrar dataset original a 3 clases
```python
# Excluir Lung_Opacity del dataset original
# Mantener solo: COVID, Normal, Viral_Pneumonia
```

**Paso 2:** Re-entrenar modelo original con 3 clases
```bash
.venv/bin/python -m src_v2 train-classifier \
    outputs/original_3_classes \
    --output-dir outputs/classifier_original_3_classes \
    --epochs 50
```

**Paso 3:** Cross-evaluation justo
```bash
.venv/bin/python -m src_v2 cross-evaluate \
    outputs/classifier_original_3_classes/best_classifier.pt \
    outputs/classifier_warped_full_coverage/best_classifier.pt \
    --data-a outputs/original_3_classes \
    --data-b outputs/full_coverage_warped_dataset \
    --output-dir outputs/cross_evaluation_valid
```

### PRIORIDAD 3: Documentar Resultados (1-2 horas)

- Actualizar docs/RESULTADOS_EXPERIMENTALES_v2.md
- Reformular claims basado en nuevos datos
- Preparar tabla comparativa final

---

## COMANDOS UTILES

```bash
# Verificar estado
git status
git log --oneline -5

# Verificar CLI
.venv/bin/python -m src_v2 --help

# Correr tests
.venv/bin/python -m pytest tests/test_processing.py -v --tb=short

# Ver resultados de robustez existentes
cat outputs/robustness_warped_full_coverage.json | python -m json.tool

# Ver resultados anteriores (47% fill)
cat outputs/session29_robustness/artifact_robustness_results.json | python -m json.tool
```

---

## COMMITS RECIENTES

```
dd2bfb4 fix: clamp bounding box to max_size in get_bounding_box
827c041 feat: implementar warp_mask() y generar dataset full_coverage
a8732a4 docs: agregar introspeccion critica sesion 36
```

---

## TABLA COMPARATIVA ACTUAL

| Modelo | Accuracy | JPEG Q50 deg | JPEG Q30 deg | Fill Rate |
|--------|----------|--------------|--------------|-----------|
| Original | 98.81% | 16.14% | 29.97% | 100% |
| Warped 47% | 98.02% | **0.53%** | **1.32%** | 47% |
| Warped 99% | 98.73% | 7.34% | 16.73% | 99% |
| Original Cropped 47% | ??? | ??? | ??? | 47% |

**El experimento de control llenara los ???**

---

## HIPOTESIS A VALIDAR

### Si Original Cropped 47% tiene ~0.5% degradacion JPEG:
```
CONCLUSION: Robustez = Reduccion de Informacion
NARRATIVA: "El crop agresivo proporciona regularizacion implicita"
VALOR: Identificacion de trade-off info vs robustez
```

### Si Original Cropped 47% tiene ~16% degradacion JPEG:
```
CONCLUSION: Robustez = Normalizacion Geometrica
NARRATIVA: "El warping alinea anatomia y mejora robustez"
VALOR: Confirmacion de hipotesis original
```

---

## METRICAS DE EXITO SESION 39

| Metrica | Objetivo |
|---------|----------|
| Experimento de control | COMPLETADO con datos |
| Interpretacion clara | SI/NO normalizacion |
| Cross-eval valido | Gaps calculados |
| Documentacion | Actualizada |

---

## COMO INICIAR LA SESION

**Copia y pega esto al inicio de la conversacion:**

```
Continuo trabajo en mi tesis de clasificacion COVID-19 con normalizacion geometrica.

CONTEXTO CRITICO (de Sesion 38):
- Hallazgo: La robustez DESAPARECE con full_coverage (99% fill)
  - Warped 47% fill: 0.53% degradacion JPEG
  - Warped 99% fill: 7.34% degradacion (13.8x PEOR)
- Hipotesis: Robustez viene de REDUCCION DE INFORMACION, no normalizacion
- Necesitamos: Experimento de control para confirmar

OBJETIVO HOY:
1. Crear dataset Original Cropped (47% fill, SIN warping)
2. Entrenar clasificador en este dataset
3. Medir robustez - ESTE DATO ES CRITICO
4. Si Original Cropped ES robusto → confirma reduccion de info
5. Si Original Cropped NO es robusto → confirma normalizacion

El prompt completo esta en: Prompt para Sesion 39.txt
La documentacion de hallazgos esta en: docs/sesiones/SESION_38_VALIDACION_EXPERIMENTAL.md

¿Empezamos creando el script para generar el dataset Original Cropped?
```

---

## NOTAS IMPORTANTES

1. **Este experimento es DEFINITIVO** - Determina cual es el mecanismo real
2. **No fabricar datos** - Documentar resultados honestos aunque refuten hipotesis
3. **El resultado negativo tambien es valioso** - Identificar trade-off es contribucion
4. **Priorizar experimento de control** - Es lo mas urgente antes de deadline

---

## ARCHIVOS CLAVE PARA REVISAR

```
src_v2/processing/warp.py          # Funciones de warping
src_v2/cli.py                      # Comandos CLI
scripts/generate_warped_dataset_full_coverage.py  # Referencia para nuevo script
outputs/robustness_warped_full_coverage.json      # Resultados actuales
```

---

**Creado:** 10 Diciembre 2025
**Sesion anterior:** 38 - Validacion Experimental
**Proxima revision:** Sesion 39
